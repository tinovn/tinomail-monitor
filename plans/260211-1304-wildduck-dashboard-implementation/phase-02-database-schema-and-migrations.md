# Phase 02 — Database Schema & Migrations

## Context Links
- [Parent Plan](./plan.md)
- [PRD Section 6: Database Schema](../wildduck-dashboard-requirements.md)
- [Research: TimescaleDB Best Practices](./research/researcher-02-frontend-database-agent.md)
- Depends on: [Phase 01](./phase-01-project-setup-and-infrastructure.md)

## Overview
- **Priority:** P1 (Critical path — API and agent depend on schema)
- **Status:** pending
- **Effort:** 2-3 days
- **Description:** Implement complete TimescaleDB schema from PRD using Drizzle ORM migrations. Create hypertables, continuous aggregates, retention policies, compression policies, indexes. Seed default data (DNSBL lists, default alert rules).

## Key Insights
- TimescaleDB 15s metrics: 1h chunk intervals (research recommendation)
- Email events: 1d chunk intervals (high volume, daily queries)
- Continuous aggregates: 5m, 1h, 1d rollups for email_events
- Compression after 7 days saves ~80% storage
- PRD retention: 90d raw metrics, 180d email events, 365d blacklist checks
- PgBouncer transaction mode for agent connections
- Drizzle ORM for type-safe schema definition + migration generation

## Requirements

### Functional
- All 6 hypertables from PRD Section 6.1: metrics_system, metrics_mongodb, metrics_redis, metrics_zonemta, email_events, blacklist_checks, metrics_rspamd
- All 7 regular tables from PRD Section 6.2: nodes, sending_ips, sending_domains, alert_rules, alert_events, dashboard_users, saved_views
- 3 continuous aggregates: email_stats_5m, email_stats_1h, email_stats_daily
- Retention policies per PRD spec
- Compression policies for all hypertables
- Seed data: 25+ DNSBL entries, 23 default alert rules

### Non-Functional
- Migrations must be idempotent (safe to re-run)
- Schema must support 10K events/sec ingestion rate
- Indexes optimized for common query patterns (time DESC, node_id, from_domain, sending_ip)

## Architecture

### Drizzle Schema Files Structure
```
packages/backend/src/
├── db/
│   ├── index.ts                        # Drizzle client init
│   ├── schema/
│   │   ├── metrics-system.ts           # metrics_system hypertable
│   │   ├── metrics-mongodb.ts          # metrics_mongodb hypertable
│   │   ├── metrics-redis.ts            # metrics_redis hypertable
│   │   ├── metrics-zonemta.ts          # metrics_zonemta hypertable
│   │   ├── metrics-rspamd.ts           # metrics_rspamd hypertable
│   │   ├── email-events.ts             # email_events hypertable
│   │   ├── blacklist-checks.ts         # blacklist_checks hypertable
│   │   ├── nodes.ts                    # nodes regular table
│   │   ├── sending-ips.ts              # sending_ips regular table
│   │   ├── sending-domains.ts          # sending_domains regular table
│   │   ├── alert-rules.ts             # alert_rules regular table
│   │   ├── alert-events.ts            # alert_events regular table
│   │   ├── dashboard-users.ts          # dashboard_users regular table
│   │   ├── saved-views.ts             # saved_views regular table
│   │   └── index.ts                    # Re-export all schemas
│   ├── migrations/
│   │   └── (auto-generated by drizzle-kit)
│   ├── seed/
│   │   ├── dnsbl-list.ts               # 25+ DNSBL entries with tiers
│   │   ├── default-alert-rules.ts      # 23 template alert rules from PRD
│   │   ├── default-admin-user.ts       # Initial admin account
│   │   └── index.ts                    # Run all seeds
│   └── timescale-setup.sql             # Raw SQL for hypertables, aggregates, policies
```

### Hypertable Configuration
| Table | Chunk Interval | Retention | Compression After |
|-------|---------------|-----------|-------------------|
| metrics_system | 1 hour | 90 days | 7 days |
| metrics_mongodb | 1 hour | 90 days | 7 days |
| metrics_redis | 1 hour | 90 days | 7 days |
| metrics_zonemta | 1 hour | 90 days | 7 days |
| metrics_rspamd | 1 hour | 90 days | 7 days |
| email_events | 1 day | 180 days | 7 days |
| blacklist_checks | 1 day | 365 days | 30 days |

## Related Code Files

### Files to Create
- `packages/backend/src/db/index.ts` — Drizzle client initialization
- `packages/backend/src/db/schema/*.ts` — All schema definitions (14 files)
- `packages/backend/src/db/seed/*.ts` — Seed data (4 files)
- `packages/backend/src/db/timescale-setup.sql` — Raw SQL for TimescaleDB-specific features
- `packages/backend/drizzle.config.ts` — Drizzle Kit config

## Implementation Steps

### Step 1: Drizzle Configuration
1. Install: `drizzle-orm`, `drizzle-kit`, `postgres` (driver)
2. Create `drizzle.config.ts` pointing to schema directory
3. Create `src/db/index.ts`: init Drizzle with `postgres` driver via PgBouncer (port 6432)

### Step 2: Regular Tables (Drizzle Schema)
1. `nodes.ts` — id (text PK), hostname, ip_address, role, status, registered_at, last_seen, metadata (jsonb)
2. `sending_ips.ts` — ip (inet PK), ip_version, node_id (FK nodes), subnet, ptr_record, status, warmup_start, warmup_day, daily_limit, current_daily_sent, blacklist_count, reputation_score, last_blacklist_check, notes, timestamps
3. `sending_domains.ts` — domain (text PK), dkim/spf/dmarc configured booleans, dmarc_policy, status, daily_limit, created_at
4. `alert_rules.ts` — id (serial PK), name, description, severity, condition, threshold, duration (interval), channels (text[]), enabled, cooldown, created_at
5. `alert_events.ts` — id (serial PK), rule_id (FK), severity, status, message, details (jsonb), node_id, fired_at, resolved_at, notified
6. `dashboard_users.ts` — id (serial PK), username (unique), password_hash, role, telegram_id, email, created_at
7. `saved_views.ts` — id (serial PK), user_id (FK), name, config (jsonb), is_default, created_at

### Step 3: Hypertable Schemas (Drizzle + Raw SQL)
Drizzle doesn't natively support `create_hypertable`. Strategy:
1. Define table schemas in Drizzle (for type generation + query builder)
2. Use raw SQL migration for `create_hypertable()` calls
3. Each hypertable: define columns per PRD Section 6.1 exactly
4. Create indexes per PRD spec

Key tables:
- `metrics_system` — 20 columns: time, node_id, node_role, cpu/ram/disk/net metrics, load, tcp, open_files
- `email_events` — 24 columns: time, event_type, message_id, queue_id, from/to address+domain, mta_node, sending_ip, mx_host, status, delivery times, bounce info, message_size, auth results, spam info

### Step 4: TimescaleDB Setup SQL
Create `timescale-setup.sql` executed after Drizzle migrations:

```sql
-- Enable extension
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- Convert to hypertables
SELECT create_hypertable('metrics_system', 'time', chunk_time_interval => INTERVAL '1 hour', if_not_exists => TRUE);
SELECT create_hypertable('metrics_mongodb', 'time', chunk_time_interval => INTERVAL '1 hour', if_not_exists => TRUE);
SELECT create_hypertable('metrics_redis', 'time', chunk_time_interval => INTERVAL '1 hour', if_not_exists => TRUE);
SELECT create_hypertable('metrics_zonemta', 'time', chunk_time_interval => INTERVAL '1 hour', if_not_exists => TRUE);
SELECT create_hypertable('metrics_rspamd', 'time', chunk_time_interval => INTERVAL '1 hour', if_not_exists => TRUE);
SELECT create_hypertable('email_events', 'time', chunk_time_interval => INTERVAL '1 day', if_not_exists => TRUE);
SELECT create_hypertable('blacklist_checks', 'time', chunk_time_interval => INTERVAL '1 day', if_not_exists => TRUE);

-- Compression policies
ALTER TABLE metrics_system SET (timescaledb.compress, timescaledb.compress_orderby = 'time DESC', timescaledb.compress_segmentby = 'node_id');
SELECT add_compression_policy('metrics_system', INTERVAL '7 days');
-- (repeat for all hypertables)

-- Retention policies
SELECT add_retention_policy('metrics_system', INTERVAL '90 days');
SELECT add_retention_policy('email_events', INTERVAL '180 days');
SELECT add_retention_policy('blacklist_checks', INTERVAL '365 days');
```

### Step 5: Continuous Aggregates
Per PRD Section 6.3:
1. `email_stats_5m` — 5min buckets by from_domain, mta_node, sending_ip, event_type
2. `email_stats_1h` — 1h buckets by from_domain, to_domain, mta_node, event_type
3. `email_stats_daily` — 1d buckets by from_domain, from_user, to_domain, mta_node, sending_ip, event_type
4. Add refresh policies: 5m agg refreshes every 5min, 1h every 30min, daily every 1h
5. Retention: `email_stats_daily` keeps 730 days

### Step 6: Seed Data
1. **DNSBL list** — 25+ entries with tier classification:
   - Critical: zen.spamhaus.org, b.barracudacentral.org, bl.spamcop.net
   - High: dnsbl.sorbs.net, cbl.abuseat.org, psbl.surriel.com
   - Medium: dnsbl-1.uceprotect.net, dyna.spamrats.com, etc.
2. **Default alert rules** — All 23 from PRD Section 17.1
3. **Default admin user** — username: admin, bcrypt hashed password, role: admin

### Step 7: Migration Script
1. Create npm script `db:migrate` — runs Drizzle push + timescale-setup.sql
2. Create npm script `db:seed` — runs seed files
3. Create npm script `db:reset` — drop + recreate + migrate + seed
4. Ensure idempotent (uses IF NOT EXISTS everywhere)

## Todo List
- [ ] Configure Drizzle Kit (drizzle.config.ts)
- [ ] Create db/index.ts (Drizzle client)
- [ ] Define all 7 regular table schemas
- [ ] Define all 7 hypertable schemas
- [ ] Create timescale-setup.sql (hypertables, compression, retention)
- [ ] Create continuous aggregate definitions
- [ ] Create DNSBL seed data (25+ entries)
- [ ] Create default alert rules seed (23 rules)
- [ ] Create default admin user seed
- [ ] Create db:migrate, db:seed, db:reset scripts
- [ ] Run full migration against Docker TimescaleDB
- [ ] Verify hypertables created: `SELECT * FROM timescaledb_information.hypertables`
- [ ] Verify continuous aggregates: `SELECT * FROM timescaledb_information.continuous_aggregates`
- [ ] Verify indexes on all tables

## Success Criteria
- All 14 tables exist in TimescaleDB
- 7 hypertables confirmed via `timescaledb_information.hypertables`
- 3 continuous aggregates active with refresh policies
- Compression policies active on all hypertables
- Retention policies active per PRD spec
- Seed data: 25+ DNSBL entries, 23 alert rules, 1 admin user
- Drizzle types correctly infer all columns

## Risk Assessment
| Risk | Impact | Mitigation |
|------|--------|------------|
| Drizzle doesn't support hypertable creation | Med | Use raw SQL post-migration script |
| Continuous aggregate refresh performance | Med | Use `start_offset`/`end_offset` to limit refresh window |
| INET type not supported by Drizzle | Low | Use custom column type or text with validation |

## Security Considerations
- Admin seed password must be changed on first login
- DB credentials in .env, not in migration files
- No PII in seed data

## Next Steps
- Phase 03 uses these schemas for CRUD endpoints
- Phase 04 agent writes to metrics_system via API
